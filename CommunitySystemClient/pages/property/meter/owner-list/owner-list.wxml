<!-- pages/property/meter/owner-list/owner-list.wxml -->

<view class="page">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="header">
    <view class="header-title">ä»ªè¡¨ç®¡ç†</view>
    <!-- <view class="header-subtitle">ä¸šä¸»ä»ªè¡¨åˆ—è¡¨</view> -->
  </view>

  <!-- æœç´¢æ  -->
  <view class="search-bar">
    <view class="search-input-wrapper">
      <input
        type="text"
        class="search-input"
        placeholder="æœç´¢ä¸šä¸»åç§°æˆ–æˆ¿å·"
        placeholder-class="search-placeholder"
        value="{{searchText}}"
        bindinput="onSearchInput"
      />
      <view class="search-icon"></view>
    </view>
  </view>

  <!-- å†…å®¹åŒºåŸŸ -->
  <view class="content">
    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{empty && !loading}}" class="empty-state">
      <view class="empty-icon">ğŸ“‹</view>
      <view class="empty-text">æš‚æ— ä»ªè¡¨æ•°æ®</view>
      <view class="empty-tip">ä»ªè¡¨æ•°æ®ç”±ç³»ç»Ÿç®¡ç†å‘˜é…ç½®</view>
    </view>

    <!-- ä¸šä¸»åˆ—è¡¨ -->
    <view wx:else class="owners-list">
      <block wx:for="{{filteredOwners}}" wx:key="ownerId">
        <!-- ä¸šä¸»ä¿¡æ¯å¡ç‰‡ -->
        <view class="owner-card">
          <!-- ä¸šä¸»ä¿¡æ¯å¤´ - å¯ç‚¹å‡»ä»¥æŠ˜å /å±•å¼€ä»ªè¡¨ -->
          <view class="owner-header" bindtap="toggleOwnerMeters" data-owner-id="{{item.ownerId}}">
            <view class="owner-info">
              <view class="owner-name">{{item.ownerName}}</view>
              <view class="house-number">æˆ¿å·: {{item.houseName}}</view>
            </view>
            <view class="owner-actions">
              <view class="meter-count">{{item.meters ? item.meters.length : 0}}ä¸ªä»ªè¡¨</view>
              <view class="expand-icon" style="transform: rotate({{expandedOwners[item.ownerId] ? 180 : 0}}deg);">â–¼</view>
            </view>
          </view>

          <!-- ä»ªè¡¨åˆ—è¡¨ - å¯æŠ˜å  -->
          <view class="meters-container" wx:if="{{item.meters && item.meters.length > 0 && expandedOwners[item.ownerId]}}">
            <block wx:for="{{item.meters}}" wx:key="meterId" wx:for-item="meter">
              <!-- ä»ªè¡¨å¡ç‰‡ -->
              <view
                class="meter-card"
                data-owner-id="{{item.ownerId}}"
                data-meter-id="{{meter.meterId}}"
              >
                <view class="meter-header">
                  <view class="meter-type-badge" style="background-color: {{getMeterColor(meter.meterType)}};color: rgb(255, 255, 255);">
                    {{meter.meterType}}
                  </view>
                  <view class="meter-info">
                    <view class="meter-name">{{meter.meterName}} | {{meter.meterCode}}</view>
                    <!-- <view class="meter-code">{{meter.meterCode}}</view> -->
                  </view>
                </view>

                <view class="meter-readings">
                  <view class="reading-item">
                    <view class="reading-label">åˆå§‹å€¼</view>
                    <view class="reading-value">{{meter.initialReading || '0'}}</view>
                  </view>
                  <view class="reading-arrow">â†’</view>
                  <view class="reading-item">
                    <view class="reading-label">å½“å‰å€¼</view>
                    <view class="reading-value">{{meter.currentReading || '0'}}</view>
                  </view>
                </view>

                <!-- <view class="meter-usage">
                  ç”¨é‡: {{meter.currentReading - meter.initialReading || 0}}
                </view> -->

                <view class="meter-footer">
                  <view class="meter-time">æ›´æ–°: {{meter.lastCommTime || meter.createdAt || 'æœªçŸ¥'}}</view>
                  <view class="meter-actions">
                    <view class="meter-btn readings-btn" bindtap="onViewMeterReadings" catch:tap data-meter-id="{{meter.meterId}}" data-meter-code="{{meter.meterCode}}" data-meter-name="{{meter.meterName}}">æŠ„è¡¨ â†’</view>
                  </view>
                </view>
              </view>
            </block>
          </view>
        </view>
      </block>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:if="{{loading && owners.length === 0}}" class="loading">
      <text>åŠ è½½ä¸­...</text>
    </view>

    <!-- åŠ è½½å®Œæˆ -->
    <view wx:if="{{!hasMore && filteredOwners.length > 0}}" class="load-complete">
      å·²åŠ è½½å…¨éƒ¨æ•°æ®
    </view>
  </view>
</view>